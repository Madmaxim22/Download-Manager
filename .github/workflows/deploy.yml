name: Test and Deploy

# Триггеры запуска workflow
on:
  # При пуше в ветку main
  push:
    branches: ["main"]
  # При создании pull request в ветку main
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Задача линтера
  eslint:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Шаг 1: Получение кода из репозитория
      - name: Checkout code
        uses: actions/checkout@v4

      # Шаг 2: Настройка Node.js среды
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0" # Конкретная версия Node.js для стабильности
          cache: "yarn" # Кэширование yarn зависимостей для ускорения

      # Шаг 3: Установка зависимостей
      - name: Install dependencies
        run: yarn install # Используем ci для чистых установок в CI/CD

      # Шаг 4: Запуск eslint
      - name: Run eslint
        run: yarn lint

  # Задача сборки и деплоя (запускается только после успешного тестирования)
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [eslint] # Зависимость: выполняется только если задача eslint успешна
    # Условие: запускать только при пуше в main ветку (не при PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Шаг 1: Получение кода (повторно для чистого состояния)
      - name: Checkout code
        uses: actions/checkout@v4

      # Шаг 2: Настройка Node.js (аналогично задаче test)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"
          cache: "yarn"

      # Шаг 3: Установка зависимостей
      - name: Install dependencies
        run: yarn install

      # Шаг 4: Сборка проекта для production
      - name: Build project
        run: yarn build:prod

      # Шаг 5: Проверка наличия папки assets и файлов после сборки
      - name: Check assets folder
        run: |
          if [ ! -d "./build/assets" ]; then
            echo "Ошибка: Папка assets не создана после сборки"
            exit 1
          else
            echo "Папка assets успешно создана в ./build/"
            ls -la ./build/assets
          fi

          # Проверяем наличие конкретных файлов PDF
          echo "Проверяем наличие PDF файлов..."
          for file in ./build/assets/*.pdf; do
            if [ -e "$file" ]; then
              echo "Найден PDF файл: $(basename "$file")"
            else
              echo "PDF файлы не найдены в ./build/assets/"
              break
            fi
          done

          # Проверяем, что все ожидаемые файлы присутствуют
          EXPECTED_FILES=("Storage Standard.pdf" "Streams Standard.pdf" "XMLHttpRequest Standard.pdf")
          MISSING_FILES=()

          for expected_file in "${EXPECTED_FILES[@]}"; do
            found=false
            for actual_file in ./build/assets/*.pdf; do
              if [ -e "$actual_file" ]; then
                if [[ "$(basename "$actual_file")" == "$expected_file" ]]; then
                  found=true
                  break
                fi
              fi
            done
            
            if [ "$found" = false ]; then
              MISSING_FILES+=("$expected_file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "Ошибка: Отсутствуют следующие файлы в ./build/assets/:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          else
            echo "Все ожидаемые PDF файлы присутствуют в ./build/assets/"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

      # Шаг 6: Деплой на GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
